## ğŸ“‹ æ¦‚è¦

åœ¨ç°æœ‰çš„ Takumi é¡¹ç›®ä¸­æ–°å¢ä¸€ä¸ª TypeScript æ¨¡å—ï¼Œç”¨äºå®ç° CLI çš„è‡ªåŠ¨æ›´æ–°åŠŸèƒ½ã€‚è¯¥æ¨¡å—é€šè¿‡æŸ¥è¯¢ npm registry è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯ã€åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°ï¼Œå¹¶åŸºäº `selfUpdate` å­—æ®µæŒ‡ç¤ºçš„å†…å®¹ä¸‹è½½ã€è§£å‹ã€æ›¿æ¢æ–‡ä»¶ï¼Œä»¥å®ç°æ— éœ€æ‰‹åŠ¨ `npm i -g takumi` çš„è‡ªåŠ¨æ›´æ–°ã€‚

## ğŸ¯ è¦æ±‚

- åœ¨ Takumi ä¸­å®ç°å•ç‹¬çš„è‡ªåŠ¨æ›´æ–°æ¨¡å—ï¼ˆTypeScript ç¼–å†™ï¼‰ã€‚
- æ¯æ¬¡è¿è¡Œæ—¶è‡ªåŠ¨æ£€æŸ¥ `dist-tags.latest` æŒ‡å‘çš„æœ€æ–°ç‰ˆæœ¬ã€‚
- ä½¿ç”¨ `semver` åˆ¤æ–­å½“å‰ç‰ˆæœ¬æ˜¯å¦éœ€è¦æ›´æ–°ã€‚
- åŸºäº `package.json` ä¸­ `selfUpdate` å­—æ®µç¡®å®šæ›´æ–°ç­–ç•¥ã€‚
- ä¸‹è½½å¹¶è§£å‹ `.tar` åŒ…ä¸­çš„æŒ‡å®šæ–‡ä»¶åˆ°å½“å‰å®‰è£…è·¯å¾„ã€‚
- æ›´æ–°å®Œæˆåæç¤ºç”¨æˆ·ï¼›éœ€è¦æ‰‹åŠ¨æ›´æ–°æ—¶ä¹Ÿæç¤ºã€‚
- æ”¯æŒéç®¡ç†å‘˜ç”¨æˆ·ï¼Œå¤±è´¥æ—¶ä¿æŒå½“å‰ç‰ˆæœ¬ç»§ç»­è¿è¡Œã€‚

## ğŸ“ åŠŸèƒ½è§„æ ¼

### ç”¨æˆ·æ“ä½œå’ŒåŠŸèƒ½ååº”

- ç”¨æˆ·è¿è¡Œ `takumi` CLI æ—¶ï¼š
  1. æ¨¡å—é€šè¿‡ `https://registry.npmjs.org/takumi` æ‹‰å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯ã€‚
  2. è¯»å– `dist-tags.latest`ï¼Œæ¯”è¾ƒå½“å‰ç‰ˆæœ¬ä¸æœ€æ–°ç‰ˆæœ¬ï¼ˆä½¿ç”¨ `semver`ï¼‰ã€‚
  3. å¦‚æœæœ‰æ–°ç‰ˆæœ¬ï¼š
     - è·å– `versions[latestVersion].package.json`ã€‚
     - è§£æ `selfUpdate`ï¼š
       - `files`: éœ€è¦æ›´æ–°çš„æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹åˆ—è¡¨ã€‚
       - `needReinstall`: æ˜¯å¦éœ€è¦æ‰‹åŠ¨æ›´æ–°ã€‚
       - `changelogUrl`: æ›´æ–°æ—¥å¿—åœ°å€ã€‚
  4. ä¸‹è½½ `dist.tarball` çš„ tar åŒ…ã€‚
  5. è§£å‹åˆ°ä¸´æ—¶ç›®å½•ã€‚
  6. å°† `selfUpdate.files` ä¸­çš„æ–‡ä»¶å¤åˆ¶è¦†ç›–åˆ°å½“å‰ CLI å®‰è£…ç›®å½•ã€‚
  7. å¦‚æœ `needReinstall` ä¸º `true`ï¼Œæç¤ºç”¨æˆ·æ‰‹åŠ¨æ›´æ–°ã€‚
  8. æ›´æ–°å®Œæˆåï¼Œç»ˆç«¯æç¤ºæ–°ç‰ˆæœ¬å·å’Œ changelog é“¾æ¥ã€‚

### æŠ€æœ¯å’Œä¸šåŠ¡çº¦æŸæ¡ä»¶

- æŠ€æœ¯çº¦æŸï¼š
  - TypeScript å®ç°ï¼Œæ¨¡å—åŒ–è®¾è®¡ï¼ˆå¦‚ `src/update.ts`ï¼‰ã€‚
  - ä½¿ç”¨ node å†…ç½®çš„ `fetch` æ‹‰å– npm registry æ•°æ®ã€‚
  - ä½¿ç”¨ `semver` æ¯”è¾ƒç‰ˆæœ¬ã€‚
  - ä½¿ç”¨ `tar` åº“è§£å‹ tar åŒ…ã€‚
  - æ–‡ä»¶æ“ä½œéœ€ä½¿ç”¨ `fs`ï¼Œç”¨åŒæ­¥ã€‚
  - éœ€å…¼å®¹ Windowsã€macOSã€Linuxã€‚
  - é‡åˆ°é”™è¯¯æ—¶ï¼Œcatch åç»§ç»­æ­£å¸¸è¿è¡Œ CLIï¼Œä¸ä¸­æ–­ä¸»æµç¨‹ã€‚

- ä¸šåŠ¡çº¦æŸï¼š
  - æ¯æ¬¡å¯åŠ¨ CLI æ—¶æ£€æŸ¥æ›´æ–°ã€‚
  - ä¸åŒºåˆ† major/minor/patchï¼Œå…¨ç‰ˆæœ¬æ›´æ–°ã€‚
  - ç¦»çº¿æ—¶è·³è¿‡æ›´æ–°ã€‚
  - æ›´æ–°å®Œæˆååœ¨ç»ˆç«¯è¾“å‡ºæç¤ºï¼Œä¾‹å¦‚ï¼š
    ```
    Takumi has been updated to v1.2.3. Changelog: https://example.com/changelog
    ```
  - `needReinstall` ä¸º `true` æ—¶ï¼š
    ```
    Important update detected, please run: npm i -g takumi
    ```

### æ‰€éœ€æ•°æ®ç»“æ„å’Œè·å–æ–¹æ³•

- `npm registry` å“åº”ç»“æ„ï¼š
  - `dist-tags.latest`: æœ€æ–°ç‰ˆæœ¬å·ã€‚
  - `versions[version].selfUpdate`: åŒ…å«æ›´æ–°ä¿¡æ¯ã€‚
  - `versions[version].dist.tarball`: tar åŒ…ä¸‹è½½åœ°å€ã€‚

- æœ¬åœ°å¤„ç†ï¼š
  - ä¸‹è½½ tar â†’ è§£å‹è‡³ temp ç›®å½• â†’ å¤åˆ¶ `selfUpdate.files` â†’ è¦†ç›–åŸç›®å½•ã€‚

## ğŸ”„ äº¤äº’

- ä¸ npm registry çš„äº¤äº’ï¼š
  - `GET https://registry.npmjs.org/takumi` æ‹‰å–å…ƒæ•°æ®ã€‚
  - ä¸‹è½½ `dist.tarball` è·å–ä»£ç åŒ…ã€‚

- ä¸æ–‡ä»¶ç³»ç»Ÿçš„äº¤äº’ï¼š
  - ä¸´æ—¶ç›®å½•å­˜æ”¾è§£å‹å†…å®¹ã€‚
  - æ ¹æ® `selfUpdate.files` åˆ—è¡¨é€‰æ‹©æ€§è¦†ç›–ã€‚
  - å¤„ç†æ–‡ä»¶å†²çªã€å¤‡ä»½ï¼ˆå¦‚æœ‰éœ€è¦ï¼‰ã€‚

- ä¸ç”¨æˆ·äº¤äº’ï¼š
  - æ›´æ–°å®Œæˆæç¤ºã€‚
  - `needReinstall` ä¸º `true` æ—¶è¾“å‡ºæŒ‡ä»¤æç¤ºã€‚

## â“ æœªè§£å†³çš„é—®é¢˜

- å¦‚ä½•å¤„ç†æ›´æ–°å¤±è´¥åçš„å›æ»šï¼ˆå½“å‰åªä¿ç•™æ—§ç‰ˆæœ¬ï¼‰ã€‚
- æ˜¯å¦éœ€è¦åœ¨æ›´æ–°å‰å¤‡ä»½è¢«è¦†ç›–æ–‡ä»¶ã€‚
- å¤šæ¬¡å¹¶å‘è¿è¡Œ CLI æ—¶çš„é”æœºåˆ¶ï¼ˆé¿å…å¤šè¿›ç¨‹åŒæ—¶å†™å…¥ï¼‰ã€‚
- tar åŒ…å†…è·¯å¾„å¯èƒ½åŒ…å«åµŒå¥—ç›®å½•ï¼Œéœ€è¦ normalizeã€‚
- æœªæ¥æ˜¯å¦æ‰©å±•ä¸ºæ’ä»¶æ¶æ„çš„ç‹¬ç«‹æ›´æ–°ã€‚

## å…¶ä»–

æ–°å¢æ–‡ä»¶ `src/checkAndUpdate.ts`ï¼ŒAPI è®¾è®¡å¦‚ä¸‹ã€‚

```ts
export async function checkAndUpdate(opts: {
  debug: boolean;  // print verbose messages
  version: string; // current version
  registryBase: string; // default: https://registry.npmjs.org/
  name: string; // the name of the package to update
  ...others
}): Promise<void>;
```
